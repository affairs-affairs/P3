<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>115 å¹´åº¦å‚™å“éŠ·å”®ç«¶è³½çœ‹æ¿ (Big5 ç·¨ç¢¼ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* å¼·åˆ¶è¨­å®šå…¨ç¶²é ä½¿ç”¨æ–°ç´°æ˜é«” */
        body { 
            font-family: "PMingLiU", "æ–°ç´°æ˜é«”", "MingLiU", serif; 
            background-color: #f1f5f9; /* Slate-100 */
        }
        
        input, select, button, textarea {
            font-family: "PMingLiU", "æ–°ç´°æ˜é«”", "MingLiU", serif !important;
        }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* ç«¶è³½é¢¨æ ¼ç‰¹æ•ˆ */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* å‹•æ…‹é€²åº¦æ¢æ–œç´‹å‹•ç•« */
        .progress-striped {
            background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
            animation: progress-bar-stripes 1s linear infinite;
        }
        @keyframes progress-bar-stripes {
            from { background-position: 1rem 0; }
            to { background-position: 0 0; }
        }

        /* æ’åå¾½ç« æ¨£å¼ */
        .rank-badge {
            position: absolute;
            top: -15px;
            right: -10px;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1.6rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 10;
            background: white;
            border: 3px solid #e2e8f0;
        }
        .rank-1 { background: #fbbf24; border-color: #fff; color: #fff; animation: bounce 2s infinite; box-shadow: 0 0 15px rgba(251, 191, 36, 0.6); } /* é‡‘ */
        .rank-2 { background: #94a3b8; border-color: #fff; color: #fff; box-shadow: 0 0 10px rgba(148, 163, 184, 0.5); } /* éŠ€ */
        .rank-3 { background: #b45309; border-color: #fff; color: #fff; box-shadow: 0 0 10px rgba(180, 83, 9, 0.5); } /* éŠ… */

        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #6366f1;
            background-color: #eef2ff;
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #6366f1;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen pb-12 text-slate-800 bg-slate-100">

    <!-- é ‚éƒ¨è£é£¾æ¢ -->
    <div class="h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 w-full fixed top-0 z-50"></div>

    <div class="max-w-7xl mx-auto px-4 py-8 mt-4">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">
                    <span class="text-indigo-600">115 å¹´åº¦</span> å‚™å“éŠ·å”®ç«¶è³½çœ‹æ¿
                </h1>
                <p class="text-slate-500 font-bold mt-2 text-lg">å…¨å¹´åº¦éŠ·å”®ç¸½ç›®æ¨™ï¼š<span class="text-slate-800 text-xl">NT$ 1,000 è¬</span></p>
            </div>
            <div class="flex items-center gap-4">
                <!-- ç‹€æ…‹æŒ‡ç¤ºç‡ˆ -->
                <div id="syncStatus" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-full text-xs font-bold text-slate-400 shadow-sm">
                    <span class="w-2.5 h-2.5 rounded-full bg-slate-300" id="statusDot"></span>
                    <span id="statusText">å°šæœªåŒæ­¥</span>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½æŒ‰éˆ•å€ -->
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <!-- å·¦å´ï¼šæª”æ¡ˆåŒ¯å…¥å€ (å·²ä¿®æ­£ Big5) -->
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <label for="csvFileInput" class="upload-area cursor-pointer flex items-center gap-2 px-5 py-3 rounded-xl text-slate-600 font-bold text-sm bg-slate-50 w-full md:w-auto justify-center hover:shadow-md transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span>ğŸ“‚ åŒ¯å…¥ 115å¹´åº¦è¨‚å–®.csv</span>
                        <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileUpload(this)">
                    </label>
                    <div class="flex flex-col">
                        <span class="text-xs text-slate-500 font-bold">æ”¯æ´ Excel è½‰å‡ºçš„ CSV</span>
                        <span class="text-[10px] text-slate-400">è‡ªå‹•ä½¿ç”¨ Big5 ç·¨ç¢¼</span>
                    </div>
                </div>

                <!-- å³å´ï¼šé›²ç«¯æ“ä½œ -->
                <div class="flex gap-3 w-full md:w-auto justify-end">
                    <button onclick="syncFromCloud()" id="btnFetch" class="flex-1 md:flex-none bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 px-5 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-sm active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg>
                        å¾é›²ç«¯æŠ“å–
                    </button>
                    <button onclick="syncToCloud()" id="btnPush" class="flex-1 md:flex-none bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white px-5 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-md active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                        åŒæ­¥æ•¸æ“šè‡³é›²ç«¯
                    </button>
                </div>
            </div>
        </div>

        <!-- ç¸½é«”å„€è¡¨æ¿ (Highlight) -->
        <div class="relative bg-gradient-to-br from-indigo-900 to-slate-800 rounded-3xl p-8 text-white shadow-2xl overflow-hidden mb-10">
            <!-- è£é£¾èƒŒæ™¯ -->
            <div class="absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl"></div>
            <div class="absolute bottom-0 left-0 -mb-10 -ml-10 w-40 h-40 bg-pink-500 opacity-10 rounded-full blur-2xl"></div>
            
            <div class="relative z-10 grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
                <div class="flex flex-col justify-center">
                    <div class="text-indigo-200 text-sm font-bold uppercase tracking-widest mb-2">å¹´åº¦ç¸½é”æˆç‡</div>
                    <div class="text-6xl font-extrabold tracking-tight text-white" id="headerAchievementRate">0%</div>
                </div>
                
                <div class="flex flex-col justify-center md:border-l md:border-r border-white/10 md:px-8">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-indigo-200 text-sm font-bold">å·²é”æˆæ¥­ç¸¾</span>
                    </div>
                    <div class="text-3xl font-bold text-white mb-4" id="totalSalesText">NT$ 0</div>
                    
                    <div class="w-full bg-slate-700/50 rounded-full h-3 mb-1">
                        <div id="progressBar" class="bg-gradient-to-r from-cyan-400 to-blue-500 h-3 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(56,189,248,0.5)]" style="width: 0%"></div>
                    </div>
                </div>

                <div class="flex flex-col justify-center items-center md:items-end">
                    <div class="text-indigo-200 text-sm font-bold uppercase tracking-widest mb-2">è·é›¢å¹´åº¦ç›®æ¨™å°šç¼º</div>
                    <div class="text-4xl font-bold text-rose-400" id="remainingTargetText">NT$ 10,000,000</div>
                    <div class="mt-2 text-xs bg-white/10 px-3 py-1 rounded-full text-indigo-100">åŠ æ²¹ï¼å†æ¥å†å²</div>
                </div>
            </div>
        </div>

        <!-- Brand Cards (Competition Style) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- åœ‹ç”¢ -->
            <div class="glass-card relative p-6 rounded-2xl bg-white border-t-4 border-blue-500" id="card-åœ‹ç”¢">
                <div id="rank-badge-åœ‹ç”¢"></div> <!-- æ’åå¾½ç« æ›è¼‰é» -->
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <span class="text-2xl font-bold text-slate-800">åœ‹ç”¢</span>
                        <div class="text-xs text-slate-400 font-bold mt-1">ç›®æ¨™: $450è¬</div>
                    </div>
                    <span id="rate-åœ‹ç”¢" class="text-3xl font-extrabold text-blue-600">0%</span>
                </div>
                
                <div class="h-3 bg-slate-100 rounded-full overflow-hidden mb-4 border border-slate-200">
                    <div id="bar-åœ‹ç”¢" class="h-full bg-blue-500 progress-striped transition-all duration-700" style="width: 0%"></div>
                </div>
                
                <div class="bg-red-50 rounded-lg p-3 border border-red-100 text-center">
                    <div class="text-xs font-bold text-red-400 uppercase mb-1">å°šç¼ºé‡‘é¡</div>
                    <div class="text-lg font-bold text-red-600" id="remain-åœ‹ç”¢">NT$ 4,500,000</div>
                </div>
            </div>
            
            <!-- å°æ³¥ -->
            <div class="glass-card relative p-6 rounded-2xl bg-white border-t-4 border-green-500" id="card-å°æ³¥">
                <div id="rank-badge-å°æ³¥"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <span class="text-2xl font-bold text-slate-800">å°æ³¥</span>
                        <div class="text-xs text-slate-400 font-bold mt-1">ç›®æ¨™: $250è¬</div>
                    </div>
                    <span id="rate-å°æ³¥" class="text-3xl font-extrabold text-green-600">0%</span>
                </div>
                
                <div class="h-3 bg-slate-100 rounded-full overflow-hidden mb-4 border border-slate-200">
                    <div id="bar-å°æ³¥" class="h-full bg-green-500 progress-striped transition-all duration-700" style="width: 0%"></div>
                </div>
                
                <div class="bg-red-50 rounded-lg p-3 border border-red-100 text-center">
                    <div class="text-xs font-bold text-red-400 uppercase mb-1">å°šç¼ºé‡‘é¡</div>
                    <div class="text-lg font-bold text-red-600" id="remain-å°æ³¥">NT$ 2,500,000</div>
                </div>
            </div>

            <!-- å–®åº— -->
            <div class="glass-card relative p-6 rounded-2xl bg-white border-t-4 border-amber-500" id="card-å–®åº—">
                <div id="rank-badge-å–®åº—"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <span class="text-2xl font-bold text-slate-800">å–®åº—</span>
                        <div class="text-xs text-slate-400 font-bold mt-1">ç›®æ¨™: $200è¬</div>
                    </div>
                    <span id="rate-å–®åº—" class="text-3xl font-extrabold text-amber-600">0%</span>
                </div>
                
                <div class="h-3 bg-slate-100 rounded-full overflow-hidden mb-4 border border-slate-200">
                    <div id="bar-å–®åº—" class="h-full bg-amber-500 progress-striped transition-all duration-700" style="width: 0%"></div>
                </div>
                
                <div class="bg-red-50 rounded-lg p-3 border border-red-100 text-center">
                    <div class="text-xs font-bold text-red-400 uppercase mb-1">å°šç¼ºé‡‘é¡</div>
                    <div class="text-lg font-bold text-red-600" id="remain-å–®åº—">NT$ 2,000,000</div>
                </div>
            </div>

            <!-- äºæ± -->
            <div class="glass-card relative p-6 rounded-2xl bg-white border-t-4 border-rose-500" id="card-äºæ±">
                <div id="rank-badge-äºæ±"></div>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <span class="text-2xl font-bold text-slate-800">äºæ±</span>
                        <div class="text-xs text-slate-400 font-bold mt-1">ç›®æ¨™: $100è¬</div>
                    </div>
                    <span id="rate-äºæ±" class="text-3xl font-extrabold text-rose-600">0%</span>
                </div>
                
                <div class="h-3 bg-slate-100 rounded-full overflow-hidden mb-4 border border-slate-200">
                    <div id="bar-äºæ±" class="h-full bg-rose-500 progress-striped transition-all duration-700" style="width: 0%"></div>
                </div>
                
                <div class="bg-red-50 rounded-lg p-3 border border-red-100 text-center">
                    <div class="text-xs font-bold text-red-400 uppercase mb-1">å°šç¼ºé‡‘é¡</div>
                    <div class="text-lg font-bold text-red-600" id="remain-äºæ±">NT$ 1,000,000</div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
            <h2 class="text-lg font-bold mb-6 text-slate-700 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>
                115 å¹´åº¦å‚™å“æœˆåº¦éŠ·å”®è¶¨å‹¢
            </h2>
            <div class="h-80">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Form -->
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 sticky top-8">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">
                        <span class="w-1.5 h-6 bg-indigo-500 rounded-full"></span>
                        æ‰‹å‹•æ•¸æ“šè£œç™»
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-bold text-slate-600 mb-2">æœˆä»½</label>
                                <select id="monthInput" class="w-full bg-slate-50 border-slate-300 border rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                                    <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}æœˆ</option>`);</script>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-bold text-slate-600 mb-2">å“ç‰Œé …ç›®</label>
                                <select id="itemInput" class="w-full bg-slate-50 border-slate-300 border rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                                    <option value="åœ‹ç”¢">åœ‹ç”¢</option>
                                    <option value="å°æ³¥">å°æ³¥</option>
                                    <option value="å–®åº—">å–®åº—</option>
                                    <option value="äºæ±">äºæ±</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-indigo-600 mb-2">ç•¶æœˆå‚™å“éŠ·å”®é¡ (NT$)</label>
                            <input type="number" id="amountInput" placeholder="è«‹è¼¸å…¥é‡‘é¡" class="w-full bg-indigo-50/30 border-indigo-200 border rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 outline-none transition-all font-bold text-lg">
                        </div>

                        <button onclick="updateData()" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-800 hover:from-indigo-700 hover:to-indigo-900 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all transform active:scale-[0.98]">
                            æäº¤ä¸¦æ›´æ–°çµ±è¨ˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                        <h2 class="text-lg font-bold text-slate-700">115 å¹´åº¦éŠ·å”®æ˜ç´°è¡¨</h2>
                        <span class="text-xs text-slate-400 font-bold bg-slate-100 px-2 py-1 rounded">ä¾†æº: <span id="dataSourceType">æœ¬åœ°/é›²ç«¯</span></span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50">
                                    <th class="px-5 py-4 text-sm font-bold text-slate-600 border-b">æœˆä»½</th>
                                    <th class="px-5 py-4 text-sm font-bold text-slate-600 border-b">å„é …ç›®é‡‘é¡ (NT$)</th>
                                    <th class="px-5 py-4 text-sm font-bold text-indigo-600 border-b text-right">æœˆç¸½é¡</th>
                                    <th class="px-5 py-4 text-sm font-bold text-slate-600 border-b text-right">å¹´åº¦ç´¯è¨ˆé€²åº¦</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody" class="divide-y divide-slate-100">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>
                    <div id="emptyState" class="px-6 py-12 text-center text-slate-400 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        ç›®å‰å°šç„¡éŠ·å”®æ•¸æ“šè³‡æ–™ï¼Œè«‹åŒ¯å…¥ CSV æˆ–æ‰‹å‹•è¼¸å…¥
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // é‡è¦ï¼šè«‹å‹™å¿…åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€
        // ==========================================
        const CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbzslQThOfrVa1aTnOIH97zTe_qze92Pb_Bz55PVVDhfUlTNaTwYUREGxJuXDTJWraySxw/exec"; 

        const ANNUAL_GOALS = {
            'åœ‹ç”¢': 4500000,
            'å°æ³¥': 2500000,
            'å–®åº—': 2000000,
            'äºæ±': 1000000,
            'TOTAL': 10000000
        };

        const itemsList = ['åœ‹ç”¢', 'å°æ³¥', 'å–®åº—', 'äºæ±'];
        let store = {};
        let chart;

        window.onload = function() {
            initChart();
            updateDashboard();
            
            // å¦‚æœç¶²å€å·²ç¶“å¡«å¯«ï¼Œå‰‡è‡ªå‹•å˜—è©¦åŒæ­¥
            if (CLOUD_API_URL && CLOUD_API_URL.indexOf("/exec") !== -1) {
                syncFromCloud();
            } else {
                setStatus("å°šæœªé€£æ¥ Google è©¦ç®—è¡¨", "bg-rose-500 text-white");
            }
        };

        // --- CSV è™•ç†æ ¸å¿ƒé‚è¼¯ (Big5 ä¿®æ­£ç‰ˆ) ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            // é‡è¦ï¼šè®€å–å®Œæˆå¾ŒåŸ·è¡Œè§£æ
            reader.onload = function(e) {
                const text = e.target.result;
                processCSV(text);
                input.value = ''; // æ¸…ç©ºï¼Œå…è¨±é‡è¤‡ä¸Šå‚³
            };

            // é‡è¦ï¼šå¼·åˆ¶ä½¿ç”¨ Big5 ç·¨ç¢¼è®€å–ï¼Œè§£æ±º Excel CSV ä¸­æ–‡äº‚ç¢¼å•é¡Œ
            reader.readAsText(file, 'Big5');
        }

        function processCSV(text) {
            const lines = text.split(/\r\n|\n/);
            const newStore = {};
            let hasValidData = false;
            let importCount = 0;

            // å¾ç¬¬ 1 è¡Œé–‹å§‹ (è·³éæ¨™é¡Œ)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // è™•ç† CSV å¯èƒ½çš„é€—è™Ÿ (é€™è£¡å‡è¨­ç°¡å–®åˆ†å‰²ï¼Œå¦‚æœå…§å®¹æœ‰é€—è™ŸæœƒéŒ¯ä½ï¼Œä½†ä¸€èˆ¬ Excel åŒ¯å‡ºç„¡å¼•è™Ÿå¯ç›´æ¥ç”¨)
                const cols = line.split(',');
                
                // æª¢æŸ¥æ¬„ä½æ•¸é‡æ˜¯å¦è¶³å¤  (è‡³å°‘è¦æœ‰æ—¥æœŸã€é‡‘é¡ã€å®¢æˆ¶)
                if (cols.length < 7) continue;

                // æ ¹æ“š CSV çµæ§‹: 
                // Index 0: æ—¥æœŸ (2026-01-05)
                // Index 5: æœªç¨…æœ¬ä½å¹£
                // Index 6: å®¢æˆ¶ç°¡ç¨±
                const dateStr = cols[0].trim(); 
                const priceStr = cols[5].trim();
                const customerName = cols[6].trim();

                // è§£ææ—¥æœŸ
                let month = 0;
                if (dateStr.includes('-')) {
                    const parts = dateStr.split('-');
                    if (parts.length >= 2) month = parseInt(parts[1], 10);
                } else if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length >= 2) month = parseInt(parts[1], 10);
                }

                if (month < 1 || month > 12) continue;

                // è§£æé‡‘é¡
                const price = parseFloat(priceStr) || 0;
                
                // è§£æå“ç‰Œ
                let brand = 'å–®åº—'; 
                if (customerName.includes('åœ‹ç”¢')) brand = 'åœ‹ç”¢';
                else if (customerName.includes('å°æ³¥')) brand = 'å°æ³¥';
                else if (customerName.includes('äºæ±')) brand = 'äºæ±';
                
                // åˆå§‹åŒ–æœˆä»½è³‡æ–™çµæ§‹
                if (!newStore[month]) {
                    newStore[month] = { 'åœ‹ç”¢': 0, 'å°æ³¥': 0, 'å–®åº—': 0, 'äºæ±': 0 };
                }

                newStore[month][brand] += price;
                hasValidData = true;
                importCount++;
            }

            if (hasValidData) {
                store = newStore;
                updateDashboard();
                showToast(`âœ… åŒ¯å…¥æˆåŠŸï¼å…±è™•ç† ${importCount} ç­†è³‡æ–™`, "success");
                setStatus("å·²åŒ¯å…¥ CSV (Big5)", "bg-amber-400 text-slate-800");
                document.getElementById('dataSourceType').innerText = "Excel/CSV åŒ¯å…¥ (Big5)";
            } else {
                showToast("âŒ åŒ¯å…¥å¤±æ•—ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆè³‡æ–™ï¼Œè«‹ç¢ºèª CSV æ ¼å¼", "error");
            }
        }

        // --- API èˆ‡ UI é‚è¼¯ ---

        async function fetchWithRetry(url, options = {}, retries = 3, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                return response;
            } catch (err) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        function setStatus(text, colorClass) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            // æ¸…é™¤ä¹‹å‰çš„é¡è‰²é¡åˆ¥
            document.getElementById('syncStatus').className = `flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-full text-xs font-bold shadow-sm ${colorClass.includes('text') ? '' : 'text-slate-400'}`;
            dot.className = `w-2.5 h-2.5 rounded-full ${colorClass.split(' ')[0]}`;
            txt.innerText = text;
        }

        async function syncFromCloud() {
            if (!CLOUD_API_URL || CLOUD_API_URL.indexOf("...") !== -1) {
                return showToast("å°šæœªè¨­å®š Google API ç¶²å€", "error");
            }
            const btn = document.getElementById('btnFetch');
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<span class="loader"></span>è®€å–ä¸­...`;
            btn.disabled = true;
            setStatus("æ­£åœ¨å¾é›²ç«¯æŠ“å–...", "bg-amber-400 animate-pulse");

            try {
                const res = await fetchWithRetry(CLOUD_API_URL);
                const data = await res.json();
                if (data && typeof data === 'object') {
                    store = data;
                    updateDashboard();
                    showToast("âœ… é›²ç«¯æ•¸æ“šæŠ“å–æˆåŠŸï¼");
                    setStatus("å·²åŒæ­¥ (é›²ç«¯)", "bg-emerald-500");
                    document.getElementById('dataSourceType').innerText = "é›²ç«¯åŒæ­¥";
                }
            } catch (e) {
                console.error(e);
                showToast("âŒ ç„¡æ³•é€£æ¥é›²ç«¯", "error");
                setStatus("é€£æ¥å¤±æ•—", "bg-rose-500");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        async function syncToCloud() {
            if (!CLOUD_API_URL || CLOUD_API_URL.indexOf("...") !== -1) {
                return showToast("è«‹å…ˆè¨­å®š API ç¶²å€", "error");
            }
            const btn = document.getElementById('btnPush');
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<span class="loader"></span>åŒæ­¥ä¸­...`;
            btn.disabled = true;
            setStatus("æ­£åœ¨ä¸Šå‚³...", "bg-amber-400 animate-pulse");

            try {
                await fetch(CLOUD_API_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(store)
                });
                showToast("ğŸš€ è³‡æ–™åŒæ­¥å‘½ä»¤å·²é€å‡º");
                setStatus("å·²åŒæ­¥ (å‰›æ‰)", "bg-emerald-500");
                document.getElementById('dataSourceType').innerText = "å·²ä¸Šå‚³é›²ç«¯";
            } catch (e) {
                showToast("âŒ åŒæ­¥å¤±æ•—", "error");
                setStatus("åŒæ­¥å¤±æ•—", "bg-rose-500");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        function initChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            // æ¼¸å±¤èƒŒæ™¯
            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

            chart = new Chart(ctx, {
                type: 'line', // æ”¹ç‚ºæŠ˜ç·šåœ–æ›´æœ‰è¶¨å‹¢æ„Ÿï¼Œæˆ–è€…ä¿æŒ Bar ä½†åŠ å¼·ç¾è§€
                data: {
                    labels: Array.from({length: 12}, (_, i) => `${i + 1}æœˆ`),
                    datasets: [{
                        label: 'æœˆéŠ·å”®ç¸½é¡',
                        data: Array(12).fill(0),
                        backgroundColor: gradient,
                        borderColor: '#6366f1',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#6366f1',
                        pointHoverBackgroundColor: '#6366f1',
                        pointHoverBorderColor: '#fff',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleFont: { family: 'PMingLiU', size: 14 },
                            bodyFont: { family: 'PMingLiU', size: 14 },
                            padding: 12,
                            callbacks: {
                                label: (ctx) => ` éŠ·å”®é¡: NT$ ${ctx.parsed.y.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#f1f5f9' },
                            ticks: { 
                                font: { family: 'PMingLiU' },
                                callback: (val) => val.toLocaleString() 
                            }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { font: { family: 'PMingLiU' } }
                        }
                    }
                }
            });
        }

        function updateDashboard() {
            const tableBody = document.getElementById('salesTableBody');
            const emptyState = document.getElementById('emptyState');
            
            let totalActualAllMonths = 0;
            let runningYearlyTotal = 0;
            let chartData = Array(12).fill(0);
            let brandYearlyTotals = { 'åœ‹ç”¢': 0, 'å°æ³¥': 0, 'å–®åº—': 0, 'äºæ±': 0 };

            tableBody.innerHTML = '';
            
            const monthsPresent = Object.keys(store).sort((a,b) => a-b);

            monthsPresent.forEach(m => {
                const data = store[m];
                let mActualTotal = 0;
                let detailRows = '';
                
                itemsList.forEach(it => {
                    const actual = data[it] || 0;
                    mActualTotal += actual;
                    brandYearlyTotals[it] += actual;
                    detailRows += `
                        <div class="flex justify-between items-center gap-4 py-1 border-b border-slate-50 last:border-0">
                            <span class="text-slate-500 font-bold text-[13px] w-12">${it}</span>
                            <span class="text-slate-800 font-bold text-[13px]">NT$ ${actual.toLocaleString()}</span>
                        </div>
                    `;
                });

                totalActualAllMonths += mActualTotal;
                runningYearlyTotal += mActualTotal;
                chartData[m-1] = mActualTotal;

                tableBody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-5 py-4 font-bold text-slate-800 border-b">${m}æœˆ</td>
                        <td class="px-5 py-4 min-w-[200px] border-b">${detailRows}</td>
                        <td class="px-5 py-4 text-right border-b"><div class="font-bold text-indigo-600 text-base">NT$ ${mActualTotal.toLocaleString()}</div></td>
                        <td class="px-5 py-4 text-right border-b">
                            <div class="text-[11px] text-slate-400 font-bold uppercase">ç´¯è¨ˆè‡³ä»Š</div>
                            <div class="font-bold text-slate-700">NT$ ${runningYearlyTotal.toLocaleString()}</div>
                        </td>
                    </tr>
                `;
            });

            if (monthsPresent.length === 0) emptyState.classList.remove('hidden');
            else emptyState.classList.add('hidden');

            // --- ç«¶è³½æ’åé‚è¼¯ ---
            let ranks = [];
            itemsList.forEach(it => {
                const rate = (brandYearlyTotals[it] / ANNUAL_GOALS[it] * 100);
                const remaining = Math.max(0, ANNUAL_GOALS[it] - brandYearlyTotals[it]);
                
                // æ›´æ–°å„å“ç‰Œæ•¸æ“š
                document.getElementById(`rate-${it}`).innerText = `${rate.toFixed(1)}%`;
                document.getElementById(`bar-${it}`).style.width = `${Math.min(rate, 100)}%`;
                document.getElementById(`remain-${it}`).innerText = `NT$ ${remaining.toLocaleString()}`;

                // æ¸…é™¤èˆŠå¾½ç« 
                const badgeContainer = document.getElementById(`rank-badge-${it}`);
                badgeContainer.innerHTML = '';
                badgeContainer.className = '';

                if (rate > 0) {
                    ranks.push({ name: it, rate: rate });
                }
            });

            // æ’åºä¸¦é ’ç™¼çç« 
            ranks.sort((a, b) => b.rate - a.rate);
            ranks.forEach((r, index) => {
                const badgeContainer = document.getElementById(`rank-badge-${r.name}`);
                if (index === 0) {
                    badgeContainer.innerHTML = 'ğŸ‘‘'; // å† è»
                    badgeContainer.className = 'rank-badge rank-1';
                } else if (index === 1) {
                    badgeContainer.innerHTML = 'ğŸ¥ˆ'; // äºè»
                    badgeContainer.className = 'rank-badge rank-2';
                } else if (index === 2) {
                    badgeContainer.innerHTML = 'ğŸ¥‰'; // å­£è»
                    badgeContainer.className = 'rank-badge rank-3';
                }
            });

            // æ›´æ–°ç¸½è¡¨
            const overallRate = (totalActualAllMonths / ANNUAL_GOALS['TOTAL'] * 100).toFixed(1);
            const remainingTotal = Math.max(0, ANNUAL_GOALS['TOTAL'] - totalActualAllMonths);

            document.getElementById('headerAchievementRate').innerText = `${overallRate}%`;
            document.getElementById('totalSalesText').innerText = `NT$ ${totalActualAllMonths.toLocaleString()}`;
            document.getElementById('remainingTargetText').innerText = `NT$ ${remainingTotal.toLocaleString()}`;
            document.getElementById('progressBar').style.width = `${Math.min(overallRate, 100)}%`;

            chart.data.datasets[0].data = chartData;
            chart.update();
        }

        function updateData() {
            const month = parseInt(document.getElementById('monthInput').value);
            const item = document.getElementById('itemInput').value;
            const actualVal = parseFloat(document.getElementById('amountInput').value) || 0;
            if (!store[month]) {
                store[month] = {};
                itemsList.forEach(name => store[month][name] = 0);
            }
            store[month][item] = actualVal;
            updateDashboard();
            setStatus("æœ¬åœ°å·²è®Šå‹•", "bg-amber-400 text-slate-800");
            showToast(`${month}æœˆã€Œ${item}ã€å·²æ›´æ–°`, "success");
            document.getElementById('dataSourceType').innerText = "æ‰‹å‹•è¼¸å…¥";
        }

        function showToast(msg, type = "info") {
            const toast = document.createElement('div');
            const bgColor = type === "error" ? "bg-red-600" : (type === "success" ? "bg-emerald-600" : "bg-slate-800");
            toast.className = `fixed bottom-8 right-8 ${bgColor} text-white px-6 py-4 rounded-xl shadow-2xl z-50 text-sm font-bold transition-all duration-300 transform translate-y-0 opacity-100`;
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate-y-4';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    </script>
</body>
</html>
